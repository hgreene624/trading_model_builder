# Strategy Adapter Model Inputs

This note summarizes every input on the **Strategy Adapter** page that directly feeds the training and evaluation stack. Use it as a plain-language companion when you are configuring runs or explaining the workflow to collaborators.

## Data & Context Controls

| Control | What it does | Why it matters |
| --- | --- | --- |
| **Portfolio** | Loads a saved list of tickers and normalizes the symbols before training begins.【F:pages/2_Strategy_Adapter.py†L200-L238】 | The evolutionary search evaluates every candidate parameter set across the selected symbols. Broader portfolios increase runtime but produce more robust fitness estimates because metrics such as trades, CAGR, and drawdown are aggregated across more markets.【F:src/models/general_trainer.py†L26-L104】【F:src/optimization/evolutionary.py†L219-L320】 |
| **Strategy module** | Lets you pick the strategy wrapper that exposes `run_strategy`. The page currently offers `src.models.atr_breakout`.| The module determines which parameter names are valid and which backtest logic the EA explores.【F:pages/2_Strategy_Adapter.py†L238-L240】【F:src/models/atr_breakout.py†L1-L27】 |
| **Training window** | The page automatically defines `start = now - 365 days` and `end = now` each time you click **Train**.【F:pages/2_Strategy_Adapter.py†L526-L532】 | Every evolutionary evaluation uses this lookback. Adjusting the window in code changes how many bars the backtests consume, which affects the stability of metrics such as drawdown and CAGR.【F:src/optimization/evolutionary.py†L219-L320】 |
| **Starting equity** | Specifies the notional capital passed into each backtest run.【F:pages/2_Strategy_Adapter.py†L405-L406】【F:pages/2_Strategy_Adapter.py†L688-L702】 | Acts as the bankroll for position sizing inside `backtest_atr_breakout`. When reward/risk sizing is disabled the engine allocates the entire bankroll (optionally scaled by volatility targeting); enabling the new sizing toggle uses this value to determine how much capital is risked per trade before scaling by reward/risk multipliers.【F:src/backtest/engine.py†L1014-L1202】 |
| **Jobs (processes)** | Sets the number of worker processes used during evolutionary evaluation.【F:pages/2_Strategy_Adapter.py†L410-L413】【F:pages/2_Strategy_Adapter.py†L688-L702】 | Higher parallelism shortens wall-clock time but increases data-loader pressure and CPU use. It maps directly to the `n_jobs` argument in `evolutionary_search`, which chooses between a `ProcessPoolExecutor` or single-process loop.【F:src/optimization/evolutionary.py†L219-L328】 |

## Evolutionary Search Knobs

These controls shape the evolutionary algorithm that samples, evaluates, and mutates strategy parameters.

| Control | How it is wired | Impact on training |
| --- | --- | --- |
| **Generations** | Passed to `evolutionary_search(..., generations=...)`.【F:pages/2_Strategy_Adapter.py†L283-L372】【F:pages/2_Strategy_Adapter.py†L688-L702】 | Determines how many evolutionary cycles run. More generations allow the population to refine toward higher scores at the cost of longer runtime.【F:src/optimization/evolutionary.py†L219-L360】 |
| **Population** | Passed as `pop_size` when invoking the search loop.【F:pages/2_Strategy_Adapter.py†L283-L372】【F:pages/2_Strategy_Adapter.py†L688-L702】 | Controls the number of candidate parameter sets explored per generation. Larger populations improve coverage of the parameter space but linearly increase evaluation cost.【F:src/optimization/evolutionary.py†L219-L320】 |
| **Min trades (gate)** | Sent to the fitness function via the `min_trades` argument.【F:pages/2_Strategy_Adapter.py†L283-L372】【F:pages/2_Strategy_Adapter.py†L688-L702】 | Any candidate whose aggregate trade count is below this threshold receives a zero fitness score, which filters out inactive configurations and prevents overfitting to small sample sizes.【F:src/optimization/evolutionary.py†L219-L360】 |
| **Jobs (EA)** | Overrides `ea_cfg["n_jobs"]`, which controls how many individuals the EA evaluates concurrently.【F:pages/2_Strategy_Adapter.py†L283-L372】【F:src/optimization/evolutionary.py†L303-L328】 | The setting throttles multiprocessing inside the EA itself. Use lower values when you hit API rate limits; raise it to accelerate local simulations. |

## Parameter Search Ranges (EA Inputs)

The sliders define the bounds for each tunable strategy parameter. The page clamps the bounds and feeds them into `param_space`, which the EA samples when creating or mutating individuals.【F:pages/2_Strategy_Adapter.py†L312-L573】 The underlying ATR breakout model interprets each field as documented below.【F:src/backtest/engine.py†L61-L132】 Narrow ranges shrink the search space (faster runs, less diversity) while wider ranges broaden exploration.

| Parameter | Strategy behavior | Training effect |
| --- | --- | --- |
| `breakout_n` | Lookback window used to compute the rolling high that triggers long entries.【F:src/backtest/engine.py†L61-L132】 | Higher values demand longer consolidations before entering, reducing trade frequency but often improving signal quality. Lower values react faster but can overtrade; the EA samples within the selected range to balance responsiveness and reliability. |
| `exit_n` | Lookback window for the rolling low that triggers exits.【F:src/backtest/engine.py†L61-L132】 | Tight exit windows (`exit_n` small) cut trades quickly, boosting win rate at the cost of premature exits. Larger windows allow trades more room, potentially increasing drawdowns. |
| `atr_n` | Period used in Wilder's ATR calculation.【F:src/backtest/engine.py†L73-L132】 | Longer ATR windows smooth volatility estimates, leading to wider stops and fewer signals. Shorter windows adapt faster but can whipsaw; the EA optimizes this trade-off. |
| `atr_multiple` | Multiplier applied to ATR in the entry threshold.【F:src/backtest/engine.py†L98-L132】 | Higher multiples require price to exceed the rolling high by a larger volatility-adjusted margin, filtering out noise but producing fewer trades. Lower multiples admit more breakouts and can improve responsiveness at the cost of more false signals. |
| `tp_multiple` | Optional profit target expressed in ATR units.【F:src/backtest/engine.py†L98-L132】 | Setting this above zero caps gains once the target is reached. Larger targets keep trades open longer; smaller targets realize profits quickly but may truncate big winners. |
| `holding_period_limit` | Maximum number of bars a position may remain open before a time-based exit fires.【F:src/backtest/engine.py†L98-L132】 | Lower limits enforce quick turnover, boosting sample size but potentially clipping trend-following trades. Higher limits let winners run but may tie up capital or allow reversals. |
| `size_mode` | Determines whether the engine sizes positions with legacy single-symbol funding or emits portfolio-aware requests that the holdout allocator rations across symbols.【F:src/backtest/engine.py†L1501-L1618】 | Choosing `rr_portfolio` keeps the risk/reward sizing logic but leaves final funding to the portfolio simulator, enabling consistent capital sharing across overlapping trades. `legacy` preserves the pre-existing behaviour for backwards compatibility. |
| `size_base_fraction` | Baseline fraction of portfolio equity requested for every new trade before reward/risk scaling applies.【F:src/backtest/engine.py†L1553-L1618】 | Raising the base fraction lets trades claim more capital even with mediocre reward/risk ratios, which can crowd out other symbols during busy periods. Lowering it keeps more cash available until the EA finds high-quality setups.【F:pages/2_Model_Builder.py†L2836-L2893】 |
| `size_rr_slope` | Incremental fraction of equity requested per +1.0 of reward/risk above the neutral target.【F:src/backtest/engine.py†L1553-L1618】 | Higher slopes aggressively scale into attractive reward/risk trades, while lower slopes keep allocations closer to the baseline so the allocator spreads capital more evenly.【F:pages/2_Model_Builder.py†L2836-L2893】 |
| `size_min_fraction` | Minimum equity fraction requested regardless of how weak the reward/risk estimate is.【F:src/backtest/engine.py†L1553-L1618】 | Prevents the allocator from starving trades entirely when reward/risk falls below the floor, but setting it too high can still exhaust cash during clusters of low-quality signals.【F:pages/2_Model_Builder.py†L2836-L2893】 |
| `size_rr_cap_fraction` | Maximum equity fraction any single trade may request at entry.【F:src/backtest/engine.py†L1553-L1618】 | Tight caps enforce diversification by forcing even stellar reward/risk trades to leave capital for other symbols; loose caps let the allocator concentrate heavily when only one instrument is active.【F:pages/2_Model_Builder.py†L2836-L2893】 |
| `rr_floor` | Reward/risk threshold below which the engine switches to the minimum fraction rather than scaling down linearly.【F:src/backtest/engine.py†L1553-L1618】 | Raising the floor makes sizing less sensitive to marginal reward/risk estimates, keeping allocations closer to `size_min_fraction`; lowering it lets the EA keep scaling down until the reward/risk ratio approaches zero.【F:pages/2_Model_Builder.py†L2836-L2893】 |
| `leverage_cap` | Portfolio-level leverage ceiling enforced by the holdout allocator when funding requested notionals across all open trades.【F:pages/2_Model_Builder.py†L1348-L1421】 | Lower caps force concurrent trades to share capital strictly within available equity, producing smoother equity curves and preventing runaway exposure. Higher caps allow controlled leverage when the EA believes staggered trades should overlap.【F:pages/2_Model_Builder.py†L1400-L1421】 |

## Session Defaults vs. Active Inputs

The **Base params** expander exposes additional fields (e.g., `risk_per_trade`, moving-average trend filter knobs). The risk sizing controls (`use_risk_reward_sizing`, `risk_reward_*`, `size_mode`, `size_*`, and `leverage_cap`) now flow directly into both the backtest engine and the EA parameter space, so enabling them immediately affects training, optimization, and the holdout allocator’s capital ledger.【F:pages/2_Model_Builder.py†L2836-L2893】【F:pages/2_Model_Builder.py†L2389-L2537】【F:src/backtest/engine.py†L1501-L1682】 Other legacy placeholders (e.g., `CV folds`, `Min trades (valid)`) remain stored in session state only and are **not** forwarded to `evolutionary_search` yet.【F:pages/2_Strategy_Adapter.py†L403-L408】 Documenting this distinction helps prevent confusion when reviewing runs.

The holdout analytics now replay portfolio equity using funded shares derived from the requested notionals, honouring the configured leverage cap and exposing both requested and funded allocations for every bar and trade.【F:pages/2_Model_Builder.py†L1348-L1538】 This ensures that the equity curve, performance heatmap, trade timeline thickness, and hover diagnostics remain coherent even when multiple symbols compete for capital under the new risk/reward sizing regime.【F:pages/2_Model_Builder.py†L1201-L1330】【F:pages/2_Model_Builder.py†L1338-L1439】

